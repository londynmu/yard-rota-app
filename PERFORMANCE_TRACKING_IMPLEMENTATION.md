# Shunter Performance Tracking System - Implementation Complete âœ…

System do automatycznego Å›ledzenia wydajnoÅ›ci shunterÃ³w z importem danych CSV, leaderboardem z medalami, oraz szczegÃ³Å‚owymi statystykami dla kaÅ¼dego uÅ¼ytkownika.

## ğŸ“¦ Co zostaÅ‚o zaimplementowane

### 1. **SQL Migration** 
ğŸ“„ `migrations/add_shunter_performance_system.sql`

**Musisz wykonaÄ‡ ten plik w Supabase SQL Editor!**

Tworzy:
- NowÄ… kolumnÄ™ `yard_system_id` w tabeli `profiles`
- NowÄ… tabelÄ™ `shunter_performance` z kolumnami:
  - `user_id`, `report_date`, `number_of_moves`
  - `avg_time_to_collect`, `avg_time_to_travel`
  - `number_of_full_locations`, `full_name_from_report`
- RLS policies (authenticated users widzÄ… wszystko, tylko admini mogÄ… dodawaÄ‡/edytowaÄ‡)
- Indexy dla szybszych zapytaÅ„
- Trigger dla auto-update timestamp

### 2. **CSV Import Helper** 
ğŸ“„ `src/utils/csvImportHelper.js`

Funkcje pomocnicze do parsowania CSV:
- `parseShunterCSV(fileContent)` - parsuje CSV z raportu
- `aggregateShiftData(parsedData)` - **sumuje ruchy z 3 shiftÃ³w tego samego dnia**
- `matchUsersWithCSV(data, profiles)` - mapuje Yard ID â†’ user_id
- `importPerformanceData(supabase, date, data)` - zapisuje do bazy

**ObsÅ‚uguje:**
- Meta-dane na poczÄ…tku CSV (Report, Generated by, Generation Time)
- Wiele shiftÃ³w dla tego samego user_id (06:00-14:00, 14:00-22:00, 22:00-06:00)
- Weighted average dla czasÃ³w collect/travel
- Automatyczne uppercase dla Yard System ID

### 3. **Admin Panel - Performance Import**
ğŸ“„ `src/components/Admin/PerformanceImport.jsx`  
ğŸ“„ `src/pages/AdminPage.jsx` (dodana nowa zakÅ‚adka "Performance")

**FunkcjonalnoÅ›Ä‡:**
- âœ… Drag & drop CSV upload
- âœ… WybÃ³r daty raportu (domyÅ›lnie wczoraj)
- âœ… Preview przed importem:
  - Zielone kartki: Zmapowani shunterzy (gotowi do importu)
  - Å»Ã³Å‚te kartki: Niezmapowani (brak Yard System ID w profilu)
- âœ… Automatyczne sumowanie ruchÃ³w z wielu shiftÃ³w
- âœ… Historia importÃ³w
- âœ… MoÅ¼liwoÅ›Ä‡ ponownego importu (overwrite)

**DostÄ™p:** Admin Panel â†’ zakÅ‚adka "Performance"

### 4. **Performance Leaderboard** 
ğŸ“„ `src/pages/PerformanceLeaderboard.jsx`  
ğŸ“„ `src/components/HomePage.jsx` (dodany link w nawigacji)

**Layout (mobile-first):**
- ğŸ† Top 3 z duÅ¼ymi medalami ğŸ¥‡ğŸ¥ˆğŸ¥‰
  - DuÅ¼e karty z avatarem, imieniem, liczbÄ… ruchÃ³w
  - ZÅ‚ote/srebrne/brÄ…zowe bordery
- ğŸ“Š Lista pozostaÅ‚ych shunterÃ³w (rank #4+)
  - Desktop: tabela z avatarami
  - Mobile: karty stackowane

**Filtry:**
- Today | This Week | This Month | All Time | Custom Range

**Sortowanie:**
- Primary: number_of_moves DESC
- Secondary: avg_time_to_collect ASC

**DostÄ™p:** 
- Desktop: Menu gÃ³rne â†’ "Performance"
- Mobile: Bottom nav â†’ "Stats" (ikona wykresÃ³w)
- URL: `/performance`

### 5. **User Profile - Performance Stats**
ğŸ“„ `src/components/User/PerformanceStats.jsx`  
ğŸ“„ `src/pages/ProfilePage.jsx` (dodana sekcja)

**WyÅ›wietla:**
- ğŸ“ˆ Total Moves (niebieski)
- ğŸ… Rank (zÅ‚oty) - np. ğŸ¥‡, ğŸ¥ˆ, ğŸ¥‰, #4
- â±ï¸ Avg Collect Time (zielony)
- ğŸšš Avg Travel Time (fioletowy)
- ğŸ“… Recent Performance (ostatnie 5 dni)
- Link do peÅ‚nego leaderboardu

**WidocznoÅ›Ä‡:**
- âœ… Tylko jeÅ›li user ma `yard_system_id`
- âœ… Nie pojawia siÄ™ podczas first-time profile setup
- âœ… Pokazuje przyjazny komunikat gdy brak danych

**DostÄ™p:** Profile â†’ sekcja na dole strony

### 6. **User Edit Form Enhancement**
ğŸ“„ `src/components/Admin/UserEditForm.jsx`

**Nowe pole: "Yard System ID"**
- âœ… Auto-uppercase (onChange: `value.toUpperCase()`)
- âœ… Visual uppercase (CSS: `textTransform: 'uppercase'`)
- âœ… Walidacja unikalnoÅ›ci (async check przed zapisem)
- âœ… Placeholder: "e.g., AG10, AK2024"
- âœ… Helper text: "Required for performance tracking"

**DostÄ™p:** Admin Panel â†’ Users â†’ Edit User (ikona oÅ‚Ã³wka)

### 7. **Navigation Updates**
ğŸ“„ `src/components/HomePage.jsx`

**Desktop menu:**
- Home | My Rota | **Performance** | Breaks | Admin | Rota Planner

**Mobile bottom nav:**
- Home | My Rota | **Stats** | Breaks | Admin

## ğŸš€ Jak zaczÄ…Ä‡ uÅ¼ywaÄ‡

### Krok 1: Wykonaj SQL Migration
```bash
# W Supabase Dashboard:
1. IdÅº do SQL Editor
2. OtwÃ³rz migrations/add_shunter_performance_system.sql
3. Skopiuj caÅ‚Ä… zawartoÅ›Ä‡
4. Wklej i kliknij "Run"
5. Poczekaj na "Success" âœ…
```

### Krok 2: Dodaj Yard System ID do uÅ¼ytkownikÃ³w
```bash
# Admin Panel â†’ Users
1. Kliknij ikonÄ™ oÅ‚Ã³wka przy uÅ¼ytkowniku
2. Wpisz jego Yard System ID (np. AG10, AK2024)
3. System automatycznie zamieni na duÅ¼e litery
4. Save Changes
```

**WaÅ¼ne:** Bez Yard System ID uÅ¼ytkownik **nie pojawi siÄ™** w statystykach!

### Krok 3: Zaimportuj pierwszy raport CSV
```bash
# Admin Panel â†’ Performance tab
1. Wybierz datÄ™ raportu (domyÅ›lnie wczoraj)
2. PrzeciÄ…gnij CSV z emaila lub kliknij "browse"
3. Poczekaj na preview:
   - Zielone: Zmapowani âœ…
   - Å»Ã³Å‚te: Brak Yard ID âš ï¸
4. Kliknij "Import X Records"
5. Gotowe! ğŸ‰
```

### Krok 4: SprawdÅº leaderboard
```bash
# KaÅ¼dy uÅ¼ytkownik moÅ¼e zobaczyÄ‡:
1. Menu â†’ Performance
2. Zobacz top 3 ğŸ¥‡ğŸ¥ˆğŸ¥‰
3. Zobacz swojÄ… pozycjÄ™ w rankingu
4. ZmieÅ„ okres: Today | Week | Month | All Time
```

## ğŸ“Š Jak dziaÅ‚a import CSV

### Proces krok po kroku:

1. **Parsowanie CSV**
   - System znajduje wiersz z nagÅ‚Ã³wkami ("Shunter user id", "Full name", etc.)
   - Ignoruje meta-dane na poczÄ…tku
   - Parsuje wszystkie wiersze danych

2. **Agregacja shiftÃ³w** âš¡
   - Ten sam Yard ID moÅ¼e wystÄ™powaÄ‡ 2-3 razy (Day/Afternoon/Night)
   - System **automatycznie sumuje ruchy**: `51 + 23 + 12 = 86 total`
   - **Weighted average** dla czasÃ³w: `(2:26Ã—51 + 1:42Ã—23 + 3:15Ã—12) / 86 = 2:18`

3. **Mapowanie na uÅ¼ytkownikÃ³w**
   - Dla kaÅ¼dego Yard ID z CSV: `AG10` â†’ szuka user z `profiles.yard_system_id = 'AG10'`
   - JeÅ›li znaleziony: âœ… matched (gotowy do importu)
   - JeÅ›li nie: âš ï¸ unmatched (pomijany, widoczny w Å¼Ã³Å‚tej sekcji)

4. **Zapis do bazy**
   - Upsert do `shunter_performance` (overwrite jeÅ›li ta sama data)
   - Jedna rekord per user per day
   - Wszystkie dane w jednej transakcji

### PrzykÅ‚ad danych z CSV:

```
Shunter user id, Full name,     No of moves, Avg collect, Avg travel
AG10,            Andy Godson,   12,          1:33,        3:15
AG10,            Andy Godson,   24,          1:42,        4:51      <- Ten sam user (shift 2)
AK2024,          Ashvinder K,   51,          3:14,        3:51
```

**Po agregacji:**
```
AG10    â†’ 36 moves total  (12+24), avg: (1:33Ã—12 + 1:42Ã—24)/36 = 1:39
AK2024  â†’ 51 moves total, avg: 3:14 collect, 3:51 travel
```

## ğŸ¨ Stylowanie (Light Mode Only)

Zgodnie z projektem [[memory:11109841]]:
- âœ… Background: `bg-offwhite` dla pages, `bg-white` dla cards
- âœ… Borders: `border-gray-200` (zawsze widoczne)
- âœ… Text: `text-charcoal` (primary), `text-gray-600` (secondary)
- âœ… Buttons: `bg-black text-white` (primary), `hover:bg-gray-100` (secondary)
- âœ… Medals: emoji ğŸ¥‡ğŸ¥ˆğŸ¥‰ + colored borders
- âœ… Zero dark mode classes

## ğŸ“± Mobile-First Design

Zgodnie z [[memory:11221674]]:
- âœ… Wszystkie komponenty dziaÅ‚ajÄ… idealnie na telefonach
- âœ… Sticky headers z badge buttons
- âœ… Cards stackowane na mobile, grid na desktop
- âœ… Bottom navigation dla szybkiego dostÄ™pu
- âœ… Touch-friendly buttons i hit areas

## ğŸ”’ BezpieczeÅ„stwo (RLS)

- âœ… **SELECT:** Wszyscy authenticated users widzÄ… wszystkie dane
  - PowÃ³d: leaderboard jest publiczny dla zespoÅ‚u
- âœ… **INSERT/UPDATE/DELETE:** Tylko admini
  - Sprawdzane przez: `profiles.role = 'admin'`

## âš ï¸ WaÅ¼ne uwagi

### 1. Brak Yard System ID
JeÅ›li uÅ¼ytkownik **nie ma** `yard_system_id` w profilu:
- âŒ Nie pojawi siÄ™ w leaderboardzie
- âŒ Nie zobaczy swoich statystyk w profilu
- âœ… Zobaczy friendly message: "You need a Yard System ID..."

### 2. Duplikaty w CSV nie sÄ… bÅ‚Ä™dem
To sÄ… rÃ³Å¼ne shifty tego samego dnia:
- 1st row: 06:00-14:00 (Day shift)
- 2nd row: 14:00-22:00 (Afternoon)  
- 3rd row: 22:00-06:00 (Night)

System **automatycznie agreguje** - nie musisz nic robiÄ‡!

### 3. Ponowny import tej samej daty
- âœ… MoÅ¼liwe - dane zostanÄ… nadpisane (upsert)
- âœ… Przydatne gdy poprawisz bÅ‚Ä…d w raporcie
- âœ… Historia importÃ³w pokaÅ¼e najnowszÄ… datÄ™

### 4. Uppercase Yard System ID
System **wymusza** duÅ¼e litery bo yard system ma wszystkie ID uppercase:
- Input onChange: `value.toUpperCase()`
- CSS: `textTransform: 'uppercase'`
- Database save: `.trim().toUpperCase()`

## ğŸ¯ Daily Workflow (dla admina)

**KaÅ¼dego dnia o 6:00+:**

1. ğŸ“§ Otrzymujesz email z CSV attachment
2. ğŸ’¾ Zachowaj CSV na dysku (backup)
3. ğŸŒ OtwÃ³rz aplikacjÄ™ â†’ Admin Panel â†’ Performance
4. ğŸ“… Wybierz datÄ™ (domyÅ›lnie wczoraj - OK)
5. ğŸ—‚ï¸ PrzeciÄ…gnij CSV z emaila
6. ğŸ‘€ SprawdÅº preview (matched/unmatched)
7. âœ… Kliknij "Import X Records"
8. ğŸ‰ Gotowe w 10 sekund!

**JeÅ›li ktoÅ› jest unmapped:**
1. Admin Panel â†’ Users
2. ZnajdÅº uÅ¼ytkownika po nazwisku
3. Edit â†’ dodaj Yard System ID
4. Save
5. WrÃ³Ä‡ do Performance â†’ ponownie upload CSV

## ğŸ“ Pliki utworzone/zmodyfikowane

### Nowe pliki:
```
migrations/add_shunter_performance_system.sql
src/utils/csvImportHelper.js
src/components/Admin/PerformanceImport.jsx
src/pages/PerformanceLeaderboard.jsx
src/components/User/PerformanceStats.jsx
```

### Zmodyfikowane pliki:
```
src/pages/AdminPage.jsx          (dodana zakÅ‚adka Performance)
src/components/HomePage.jsx      (dodany link Performance w nav)
src/components/Admin/UserEditForm.jsx  (dodane pole yard_system_id)
src/pages/ProfilePage.jsx        (dodana sekcja PerformanceStats)
```

## ğŸš§ Future Enhancements (v2)

Sugestie na przyszÅ‚oÅ›Ä‡:
- â° Gmail API: auto-pobieranie CSV z emaila
- ğŸ¤– Cron job: auto-import o 6:00 kaÅ¼dego dnia
- ğŸ“§ Email notifications: "Import successful" / "Failed"
- ğŸ“ˆ Wykresy trendÃ³w: liczba ruchÃ³w w czasie
- ğŸ… Achievements: "First place 3 days in a row!"
- ğŸ“Š Team stats: porÃ³wnanie lokacji (Rugby vs NRC)

## ğŸ†˜ Troubleshooting

### Problem: "No data to import"
- SprawdÅº czy CSV ma prawidÅ‚owy format
- Upewnij siÄ™ Å¼e sÄ… nagÅ‚Ã³wki: "Shunter user id", "No of moves"

### Problem: "Unmapped shunters"
- Dodaj Yard System ID w Admin Panel â†’ Users â†’ Edit

### Problem: "This Yard System ID is already in use"
- KaÅ¼dy user musi mieÄ‡ unikalny Yard ID
- SprawdÅº czy przypadkiem nie wpisaÅ‚eÅ› ID innego uÅ¼ytkownika

### Problem: UÅ¼ytkownik nie widzi swoich statystyk
- SprawdÅº czy ma `yard_system_id` w profilu
- SprawdÅº czy zostaÅ‚ zaimportowany jakikolwiek raport z jego danymi

## âœ… Checklist wdroÅ¼enia

- [ ] WykonaÄ‡ SQL migration w Supabase
- [ ] DodaÄ‡ Yard System ID do wszystkich aktywnych shunterÃ³w
- [ ] ZaimportowaÄ‡ pierwszy raport CSV (test)
- [ ] SprawdziÄ‡ leaderboard jako uÅ¼ytkownik
- [ ] SprawdziÄ‡ performance stats w profilu
- [ ] PrzeszkoliÄ‡ innych adminÃ³w z procesu importu
- [ ] UstawiÄ‡ daily reminder o 6:00 (opcjonalne)

---

**Implementacja zakoÅ„czona! System gotowy do uÅ¼ycia. ğŸš€**

Pytania? SprawdÅº kod lub napisz do developera.


